<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"
    integrity="sha512-s+xg36jbIujB2S2VKfpGmlC3T5V2TF3lY48DX7u2r9XzGzgPsa6wTpOQA7J9iffvdeBN0q9tKzRxVxw1JviZPg=="
    crossorigin="anonymous"></script>
  <title>Usage</title>
</head>

<body>
  <div>
    <div>
      <h2>top command</h2>
      <div id="topCommand" />
    </div>
    <div>
      <h2>用户数量</h2>
      <div id="userCount" />
    </div>
    <div>
      <h2>top group</h2>
      <div id="topGroup" />
    </div>
    <div style="height:400px">
      <canvas id="myChart"></canvas>
    </div>
  </div>

  <script type="module">
    import { html, render } from 'https://unpkg.com/htm/preact/standalone.module.js'

    function populateUserCount(users){
      render(html`<h3>${Object.keys(users).length}</h3>`, document.getElementById('userCount'))
    }
    function populateTopCommand(triggerCount) {
      const topCommand = Object.entries(triggerCount)
        .map(([command, count]) => {
          if (command.startsWith("！")) command = `!${command.slice(1)}`
          return [command, count]
        })
        .reduce((acc, [command, count]) => {
          let duplicated = acc.find(([_command]) => command === _command)
          if (!duplicated) {
            duplicated = [command, 0]
            acc.push(duplicated)
          }
          duplicated[1] += count
          return acc
        }, [])
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(([command, count]) => {
          return html`<ul>${command}: ${count}</ul>`
        })

      render(topCommand, document.getElementById("topCommand"))
    }
    function populateTopGroup(triggerCount) {
      const topCommand = Object.entries(triggerCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([group, count]) => {
          return html`<ul>${group}: ${count}</ul>`
        })

      render(topCommand, document.getElementById("topGroup"))
    }

    let myChart;
    function createTimeChart(data) {
      var ctx = document.getElementById('myChart');
      myChart = new Chart(ctx, {
        type: 'bar',
        title: "timeshift",
        data: {
          labels: [...Array(24).keys()],
          datasets: []
        },
        options: {
          legend: false,
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            xAxes: [{
              stacked: true
            }],
            yAxes: [{
              stacked: true,
              ticks: {
                beginAtZero: true
              }
            }]
          }
        }
      })
    }

    const dynamicColors = function () {
      var r = Math.floor(Math.random() * 255);
      var g = Math.floor(Math.random() * 255);
      var b = Math.floor(Math.random() * 255);
      return [r,g,b];
    };

    const rgba = ([r,g,b],a=1) =>{
      return "rgb(" + r + "," + g + "," + b + "," + a + ")"
    }

    function populateTimeChart(data){
      myChart.data.datasets = []
      Object.entries(data).map(([user, data]) =>{
        const color = dynamicColors()
        myChart.data.datasets.push({
          label: user,
          data,
          backgroundColor: rgba(color,0.25),
          borderColor: rgba([0,0,0],0.4),
          borderWidth: 1
        })
      })
      myChart.update()
    }

    (function(){
      createTimeChart()
      const interval = async function () {
        const data = await fetch("http://ri.mk:3005/message-recorder/stat/json").then(res => res.json())
        populateTimeChart(data.commandTriggerHourSummary)
        populateTopCommand(data.triggerCount)
        populateTopGroup(data.groupCount)
        populateUserCount(data.userCount)
      }
      window.setInterval(interval, 60 * 1000)
      interval()
    })()
  </script>
</body>

</html>